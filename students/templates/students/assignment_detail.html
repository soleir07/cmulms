{% load static %}
{% load youtube_extras %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Bootstrap & Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <title>CMU-LMS-STUDENT</title>
  <link rel="icon" type="image/x-icon" href="{% static 'images/cmu.jpg' %}">
  <style>
    body {
      background: linear-gradient(120deg, #f7f8fa 0%, #eef2fb 100%);
    }
    .assignment-header {
      background: linear-gradient(90deg, #5a5df5 70%, #3780c8 100%);
      color: #fff;
      border-radius: 14px;
      box-shadow: 0 3px 16px rgba(60,80,120,.11);
      padding: 28px 30px 18px 30px;
      margin-bottom: 18px;
      position: relative;
    }
    .back-btn {
      position: absolute;
      top: 18px;
      left: 24px;
      background: #fff;
      color: #6366f1;
      border-radius: 50%;
      border: none;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      box-shadow: 0 2px 8px rgba(60,80,120,.12);
      transition: background 0.17s, color 0.17s;
      z-index: 10;
    }
    .back-btn:hover { background: #eef2fb; color: #204ecf; }
    .assignment-meta {
      display: flex;
      gap: 24px;
      margin-bottom: 10px;
      align-items: center;
    }
    .assignment-meta .badge { font-size: 1rem; }
    .assignment-card {
      border: none;
      border-radius: 12px;
      background: #fff;
      box-shadow: 0 1px 8px rgba(60,80,120,.09);
    }
    .work-card {
      border: none;
      border-radius: 12px;
      background: #fff;
      box-shadow: 0 1px 8px rgba(60,80,120,.09);
    }
    .comment-box {
      background: #f1f3f4;
      border-radius: 8px;
      padding: 10px;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .comment-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
      background: #dde4ef;
      margin-right: 4px;
    }
    .comment-content {
      flex: 1;
    }
    .comment-user {
      font-weight: bold;
      color: #4751d7;
      font-size: 1rem;
    }
    .comment-time {
      font-size: 0.9em;
      color: #8c99ab;
      margin-left: 6px;
    }
    .file-attachment {
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      position: relative;
    }
    .file-attachment:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.09);
    }
    .file-download-btn {
      position: absolute;
      bottom: 8px;
      right: 10px;
      background: #6366f1;
      color: #fff;
      border-radius: 20px;
      font-size: 0.92rem;
      padding: 2px 12px;
      border: none;
      transition: background .18s;
    }
    .file-download-btn:hover { background: #204ecf; }
    /* Drag and Drop Area */
    .drop-area {
      border: 2px dashed #6366f1;
      border-radius: 10px;
      background: #f7fafd;
      transition: border-color .2s, background .2s;
      padding: 22px 10px;
      text-align: center;
      margin-bottom: 10px;
      cursor: pointer;
      position: relative;
    }
    .drop-area.dragover { border-color: #204ecf; background: #e3e8ef; }
    .drop-area .fa-cloud-upload-alt { font-size: 2.1rem; color: #6366f1; margin-bottom: 8px; }
    .drop-area input[type="file"] { display: none; }
    .upload-preview {
      margin-top: 7px;
      font-size: 1rem;
      color: #4751d7;
      word-break: break-all;
    }
    .status-badge {
      font-size: 0.97rem;
      padding: 3px 10px;
      border-radius: 12px;
      background: #eef2fb;
      color: #6366f1;
      margin-left: 6px;
    }
    @media (max-width: 600px) {
      .assignment-header { padding: 20px 8px 10px 8px; }
      .back-btn { left: 8px; top: 8px; width: 34px; height: 34px; font-size: 1.1rem;}
      .assignment-card, .work-card { border-radius: 9px; }
      .comment-avatar { width: 24px; height: 24px;}
      .file-attachment { width: 100%!important; min-width: 0!important;}
    }
  </style>
</head>
<body>
<div class="container mt-4">
  <!-- Assignment Header with Back Button -->
  <div class="assignment-header mb-4">
    <a class="back-btn" href="{% url 'students:class_detail' assignment.class_obj.id %}" title="Back to Class">
      <i class="fa fa-arrow-left"></i>
    </a>
    <h2 class="mb-2" style="margin-left:48px;">{{ assignment.title }}</h2>
    <div class="assignment-meta">
      <span class="badge bg-light text-dark">
        <i class="fa fa-calendar-alt me-1"></i>
        {{ assignment.due_date|date:"M d, Y" }} {{ assignment.due_time }}
      </span>
      <span class="badge bg-light text-dark">
        <i class="fa fa-star me-1 text-warning"></i>
        {{ assignment.points }} points
      </span>
      {% if is_past_due %}
      <span class="badge bg-danger"><i class="fa fa-clock me-1"></i> Past Due</span>
      {% endif %}
    </div>
  </div>

  <div class="row">
    <!-- Left Column: Assignment Info -->
    <div class="col-md-8">
      <div class="card assignment-card shadow-sm mb-4">
        <div class="card-body">
          <h5 class="fw-bold mb-2">Instructions</h5>
          <p>{{ assignment.instructions }}</p>
        </div>
      </div>

      <!-- Attachments Section -->
      <div class="card shadow-sm assignment-card mb-4">
        <div class="card-body">
          <h5 class="fw-bold mb-3"><i class="fas fa-paperclip me-2"></i>Attachments</h5>
          <!-- YouTube Videos -->
          {% if assignment.videos.all %}
            <div class="d-flex flex-wrap gap-2 mb-3">
              {% for v in assignment.videos.all %}
                <div class="youtube-attachment border rounded p-2 text-center shadow-sm" style="width:160px; background-color:#f8f9fa;">
                  <a href="https://www.youtube.com/watch?v={{ v.url|youtube_id }}" target="_blank">
                    <img src="https://img.youtube.com/vi/{{ v.url|youtube_id }}/0.jpg" 
                         class="img-fluid rounded" style="max-height:90px; object-fit:cover;">
                    <p class="small text-truncate mt-1">Watch</p>
                  </a>
                </div>
              {% endfor %}
            </div>
          {% endif %}
          <!-- Regular Links -->
          {% if assignment.links.all %}
            <div class="d-flex flex-column gap-2 mb-3">
              {% for link in assignment.links.all %}
                <div class="border rounded p-2 d-flex justify-content-between align-items-center shadow-sm" style="background-color:#f8f9fa;">
                  <a href="{{ link.url }}" target="_blank" class="text-decoration-none text-primary">
                    <i class="fas fa-link me-1"></i>{{ link.url }}
                  </a>
                  <small class="text-muted">{{ link.added_at|date:"M d, Y" }}</small>
                </div>
              {% endfor %}
            </div>
          {% endif %}
          <!-- Uploaded Files -->
          {% if assignment.attachments.all %}
            <div class="d-flex flex-wrap gap-3 mb-3">
              {% for f in assignment.attachments.all %}
                {% with f.file.name|lower as filename %}
                  <div class="file-attachment border rounded p-3 text-center shadow-sm" style="width:140px; background-color:#f8f9fa;">
                    {% if ".jpg" in filename or ".jpeg" in filename or ".png" in filename or ".gif" in filename %}
                      <a href="{{ f.file.url }}" target="_blank">
                        <img src="{{ f.file.url }}" class="img-fluid rounded mb-2" style="height:80px; object-fit:cover;">
                      </a>
                    {% elif ".pdf" in filename %}
                      <a href="{{ f.file.url }}" target="_blank" class="text-danger fs-3">
                        <i class="fas fa-file-pdf"></i>
                      </a>
                    {% elif ".doc" in filename or ".docx" in filename %}
                      <a href="{{ f.file.url }}" target="_blank" class="text-primary fs-3">
                        <i class="fas fa-file-word"></i>
                      </a>
                    {% elif ".xls" in filename or ".xlsx" in filename %}
                      <a href="{{ f.file.url }}" target="_blank" class="text-success fs-3">
                        <i class="fas fa-file-excel"></i>
                      </a>
                    {% elif ".zip" in filename or ".rar" in filename %}
                      <a href="{{ f.file.url }}" target="_blank" class="text-secondary fs-3">
                        <i class="fas fa-file-archive"></i>
                      </a>
                    {% elif ".ppt" in filename or ".pptx" in filename %}
                      <a href="{{ f.file.url }}" target="_blank" class="text-warning fs-3">
                        <i class="fas fa-file-powerpoint"></i>
                      </a>
                    {% else %}
                      <a href="{{ f.file.url }}" target="_blank" class="text-muted fs-3">
                        <i class="fas fa-file-alt"></i>
                      </a>
                    {% endif %}
                    <p class="small text-truncate mt-2 mb-0" title="{{ f.filename }}">{{ f.filename }}</p>
                    <small class="text-muted">{{ f.uploaded_at|date:"M d, Y" }}</small>
                    <button class="file-download-btn" onclick="window.open('{{ f.file.url }}','_blank')">
                      <i class="fa fa-download"></i> Download
                    </button>
                  </div>
                {% endwith %}
              {% endfor %}
            </div>
          {% endif %}
          <!-- No attachments -->
          {% if not assignment.videos.all and not assignment.links.all and not assignment.attachments.all %}
            <p class="text-muted mb-0">No attachments yet.</p>
          {% endif %}
        </div>
      </div>



      <!-- Class Comments -->
      <div class="card shadow-sm border-0 assignment-card">
  <div class="card-body">
    <h6 class="fw-bold mb-3 text-primary">
      <i class="fa-solid fa-comments me-2"></i>Class Comments
    </h6>

    <div class="comments-container" style="max-height: 250px; overflow-y: auto;">
      {% for comment in class_comments %}
        <div class="comment-box p-2 mb-2 rounded-3 bg-light border position-relative">
          <div class="d-flex align-items-center mb-1">
            <div class="avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" 
                 style="width: 32px; height: 32px; font-size: 14px;">
              {{ comment.user.username|slice:":1"|upper }}
            </div>
            <div>
              <strong>{{ comment.user.username }}</strong><br>
              <small class="text-muted">{{ comment.created_at|date:"M d, Y h:i A" }}</small>
            </div>
          </div>
          <div class="ms-5 text-dark">{{ comment.text }}</div>
        </div>
      {% empty %}
        <p class="text-muted fst-italic text-center py-3 mb-0">
          No comments yet. Be the first to start the discussion 💬
        </p>
      {% endfor %}
    </div>

    <form method="POST" action="{% url 'students:assignment_detail' assignment.id %}" class="mt-3">
      {% csrf_token %}
      <div class="input-group">
        <input type="text" name="class_comment" class="form-control rounded-start-pill" 
               placeholder="Write a comment..." required>
        <button class="btn btn-primary rounded-end-pill px-4" type="submit" name="post_class_comment">
          <i class="fa-solid fa-paper-plane me-1"></i>Post
        </button>
      </div>
    </form>
  </div>
</div>

      
    </div>

    <!-- Right Column: Student Work -->
    <div class="col-md-4">
      <div class="card shadow-sm work-card mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="fw-bold">Your work</h6>
            {% if submission and submission.is_submitted %}
              <span class="status-badge text-success">Submitted</span>
            {% endif %}
          </div>
          {% if submission and submission.is_submitted %}
            <div class="mb-3">
              <small class="text-muted">
                Submitted on {{ submission.submitted_at|date:"M d, Y H:i" }}
              </small>
            </div>
            {% if submission.file %}
              <div class="comment-box mb-3">
                <i class="fa-solid fa-paperclip me-1"></i>
                <a href="{{ submission.file.url }}" target="_blank">
                  {{ submission.file.name|slice:":30" }}
                </a>
              </div>
            {% endif %}
            <form method="post">
              {% csrf_token %}
              <button type="submit" name="unsubmit" class="btn btn-outline-danger w-100"
                      {% if is_past_due %}disabled{% endif %}>
                Unsubmit
              </button>
            </form>
          {% else %}
            <form method="post" enctype="multipart/form-data">
              {% csrf_token %}
              <label class="form-label">Upload your work</label>
              <!-- Drag & Drop Area -->
              <div class="drop-area" id="dropArea">
                <i class="fa fa-cloud-upload-alt"></i>
                <div class="fw-bold">Drag & Drop file here or click to choose</div>
                <input type="file" name="file" id="fileInput" {% if is_past_due %}disabled{% endif %}>
                <div class="upload-preview" id="uploadPreview"></div>
              </div>
              <!-- Add or Create Button -->
              <button type="button" class="btn btn-outline-secondary w-100 mb-2"
                      data-bs-toggle="modal" data-bs-target="#createModal"
                      {% if is_past_due %}disabled{% endif %}>
                + Add or Create
              </button>
              <button type="submit" name="hand_in" class="btn btn-primary w-100"
                      {% if is_past_due %}disabled{% endif %}>
                Hand in
              </button>
            </form>
          {% endif %}
        </div>
      </div>

      <!-- Private Comments -->
      <div class="card shadow-sm work-card">
        <div class="card-body">
          <h6 class="fw-bold mb-3">
            <i class="fa-solid fa-user me-1"></i> Private comments
          </h6>
          {% for comment in private_comments %}
            <div class="comment-box mb-2">
              <strong>
                {% if comment.user == request.user %}
                  You
                {% else %}
                  {{ comment.user.get_full_name }}
                {% endif %}
                {% if comment.recipient and comment.recipient != request.user %}
                  to {{ comment.recipient.get_full_name }}
                {% endif %}
              </strong><br>
              {{ comment.text }}
              <small class="text-muted d-block text-end">{{ comment.created_at|timesince }} ago</small>
            </div>
          {% empty %}
            <p class="text-muted">No private comments yet.</p>
          {% endfor %}

          <form method="POST" action="{% url 'students:assignment_detail' assignment.id %}">
            {% csrf_token %}
            <div class="input-group mt-2">
              <input type="text" name="private_comment" class="form-control" 
                     placeholder="Add comment to teacher...">
              <button class="btn btn-primary" type="submit" name="post_private_comment">Send</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Drag & Drop JS -->
<script>
const dropArea = document.getElementById('dropArea');
const fileInput = document.getElementById('fileInput');
const uploadPreview = document.getElementById('uploadPreview');

dropArea.addEventListener('click', () => {
  if (!fileInput.disabled) fileInput.click();
});
['dragenter', 'dragover'].forEach(evt => {
  dropArea.addEventListener(evt, e => {
    e.preventDefault();
    dropArea.classList.add('dragover');
  });
});
['dragleave', 'drop'].forEach(evt => {
  dropArea.addEventListener(evt, e => {
    e.preventDefault();
    dropArea.classList.remove('dragover');
  });
});
dropArea.addEventListener('drop', e => {
  e.preventDefault();
  if (!fileInput.disabled && e.dataTransfer.files.length) {
    fileInput.files = e.dataTransfer.files;
    showUploadPreview(e.dataTransfer.files[0]);
  }
});
fileInput.addEventListener('change', () => {
  if (fileInput.files.length) showUploadPreview(fileInput.files[0]);
});
function showUploadPreview(file) {
  uploadPreview.innerHTML = `<span class="fw-bold">${file.name}</span>
    <span class="text-muted">(${(file.size/1024).toFixed(1)} KB)</span>`;
}
</script>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
