{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CMU-LMS-STUDENT</title>
  <link rel="icon" type="image/x-icon" href="{% static 'images/cmu.jpg' %}">
  <style>
    body { background: linear-gradient(120deg, #e3f0ff 0%, #f2f6ff 100%); min-height: 100vh; margin: 0; font-family: 'Segoe UI', 'Roboto', Arial, sans-serif; }
    .quiz-container { max-width: 720px; margin: 2.5rem auto; background: #fff; border-radius: 22px; box-shadow: 0 8px 24px rgba(33,61,138,0.13), 0 2px 4px rgba(30,136,229,0.06); padding: 2.5rem 2rem 2rem; position: relative; overflow: hidden; animation: fadeInQuiz .5s; }
    @keyframes fadeInQuiz { from { opacity: 0; transform: translateY(40px);} to { opacity: 1; transform: none;} }
    .quiz-title { font-size: 2rem; font-weight: 700; color: #263373; margin-bottom: 0.25em; text-align: center; }
    .quiz-description { font-size: 1rem; color: #49536b; background: #e3eafd; border-radius: 10px; text-align: center; margin-bottom: 1.5em; padding: .8em 1em; }
    .quiz-meta { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5em; }
    .timer { font-size: 1.2rem; font-weight: 700; color: #d32f2f; background: #fce4ec; padding: .5em 1em; border-radius: 8px; box-shadow: 0 2px 6px rgba(244,67,54,0.2); }
    .badge-status { padding: .4em .7em; border-radius: 8px; font-size: .9rem; font-weight: 600; }
    .badge-success { background: #e8f5e9; color: #2e7d32; }
    .quiz-question-card { border: 2px solid #e8eaf6; border-radius: 14px; background: #fafbff; margin-bottom: 1.5em; padding: 1.2em; transition: box-shadow .18s, border-color .18s; }
    .quiz-question-card:hover { box-shadow: 0 5px 20px rgba(26,35,126,0.09); border-color: #7986cb; }
    .quiz-question-number { color: #3366cc; font-weight: 600; margin-bottom: .4em; }
    .quiz-question-text { font-size: 1.1rem; color: #232f44; margin-bottom: 1em; font-weight: 500; }
    .form-check { margin-bottom: 0.75em; }
    .form-control { border-radius: 8px; border: 1.5px solid #c5cae9; padding: .7em .9em; background: #f9fbfc; font-size: 1rem; }
    .form-control:focus { border-color: #5c6bc0; background: #e8f0fe; outline: none; }
    .quiz-submit-btn { width: 100%; background: linear-gradient(90deg, #3949ab 65%, #1e88e5 100%); border: none; color: #fff; font-weight: 700; padding: 1em; font-size: 1.1rem; border-radius: 9px; margin-top: 1.5em; box-shadow: 0 2px 10px rgba(30,136,229,0.13); transition: background .15s, transform .13s; }
    .quiz-submit-btn:hover { background: linear-gradient(90deg, #1e88e5 40%, #3949ab 100%); transform: translateY(-2px); }
    .quiz-progress-bar { width: 100%; height: 8px; background: #e3eafd; border-radius: 5px; overflow: hidden; margin-bottom: 2em; }
    .quiz-progress-bar-inner { height: 100%; background: linear-gradient(90deg, #3949ab 65%, #1e88e5 100%); width: 0%; transition: width 1s linear; }
  </style>
</head>
<body>
<div class="quiz-container">

  <h2 class="quiz-title">{{ quiz.title }}</h2>
  <div class="quiz-description">{{ quiz.description|default:"No description" }}</div>

  <div class="quiz-meta">
    {% if submitted %}
      <span class="badge-status badge-success">Turned In</span>
    {% endif %}
    {% if not submitted and time_remaining %}
      <div id="quiz-timer" class="timer" data-remaining="{{ time_remaining }}">⏳ Loading...</div>
    {% endif %}
  </div>

  <div class="quiz-progress-bar">
    <div class="quiz-progress-bar-inner" id="progressBar"></div>
  </div>

  <form id="quizForm" method="post" autocomplete="off">
    {% csrf_token %}
    {% for pair in qa_pairs %}
      {% with question=pair.question answer=pair.answer %}
        <div class="quiz-question-card">
          <div class="quiz-question-number">Q{{ forloop.counter }}</div>
          <div class="quiz-question-text">{{ question.text }}</div>

          {% if submitted %}
            <p><strong>Your answer:</strong>
              {% if answer and answer.selected_option %}{{ answer.selected_option.text }}
              {% elif answer and answer.text_answer %}{{ answer.text_answer }}
              {% else %}<em>No answer</em>{% endif %}
            </p>
          {% else %}
            {% if question.question_type == "multiple-choice" %}
              {% for option in question.options.all %}
                <div class="form-check">
                  <input type="radio" class="form-check-input" name="question_{{ question.id }}" value="{{ option.id }}" id="opt{{ option.id }}">
                  <label class="form-check-label" for="opt{{ option.id }}">{{ option.text }}</label>
                </div>
              {% endfor %}
            {% elif question.question_type == "identification" %}
              <input type="text" class="form-control" name="question_{{ question.id }}" placeholder="Type your answer">
            {% elif question.question_type == "essay" %}
              <textarea class="form-control" name="question_{{ question.id }}" rows="4" placeholder="Write your essay here"></textarea>
            {% endif %}
          {% endif %}
        </div>
      {% endwith %}
    {% endfor %}

    {% if not submitted %}
      <button type="submit" class="quiz-submit-btn">Submit Quiz</button>
    {% else %}
      <a href="{% url 'students:class_detail' id=quiz.class_obj.id %}" class="quiz-submit-btn" style="display:block; text-align:center; text-decoration:none;">Back to Classwork</a>
    {% endif %}
  </form>
</div>

<script>
  // Countdown Timer + Auto Submit
  const timerEl = document.getElementById("quiz-timer");
  const form = document.getElementById("quizForm");
  const progressBar = document.getElementById("progressBar");

  if (timerEl) {
    let remaining = parseInt(timerEl.dataset.remaining, 10); // in seconds
    const total = remaining;

    function updateTimer() {
      if (remaining <= 0) {
        timerEl.textContent = "⏰ Time's up!";
        form.submit(); // auto-submit
      } else {
        const mins = Math.floor(remaining / 60);
        const secs = remaining % 60;
        timerEl.textContent = `⏳ ${mins}:${secs.toString().padStart(2, "0")}`;
        progressBar.style.width = `${((total - remaining) / total) * 100}%`;
        remaining--;
      }
    }

    updateTimer();
    setInterval(updateTimer, 1000);
  }
</script>
</body>
</html>
