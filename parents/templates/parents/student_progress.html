{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CMU-LMS</title>
  <link rel="icon" type="image/x-icon" href="{% static 'images/cmu.jpg' %}">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .card { border-radius: 1rem; }
    .section-card { border-radius: 1rem; margin-bottom: 2rem; }
    .section-card h4 { font-size: 1.15rem; margin-bottom: 1rem; }
    .list-group-item { border-radius: 0.5rem; transition: box-shadow 0.2s; }
    .list-group-item:hover { box-shadow: 0 2px 12px rgba(13,110,253,0.08); }
      /*drop down in profile*/
       .user-profile {
    position: relative;
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
}
.user-profile .user-avatar img {
    width: 37px;
    height: 37px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #4e54c8;
}
.avatar-dropdown-menu {
    display: none;
    flex-direction: column;
    position: absolute;
    top: 100%; right: 0;
    background: #fff;
    min-width: 120px;
    border-radius: 8px;
    box-shadow: 0 4px 14px rgba(0,0,0,.15);
    z-index: 1001;
    margin-top: 8px;
    padding: 8px 0;
}
.avatar-dropdown-menu a {
    display: flex; align-items: center;
    gap: 7px;
    padding: 8px 16px;
    color: #333;
    text-decoration: none;
    font-size: 14px;
    transition: background 0.17s;
}
.avatar-dropdown-menu a:hover {
    background: #f2f2f2;
}

  </style>
</head>
<body>

  <!-- Top Bar -->
  <div class="d-flex justify-content-between align-items-center p-3 bg-white shadow-sm">
    <h5 class="mb-0 fw-bold text-primary">
      <span style="font-size:1.5rem;">üìä</span> Progress for {{ student.get_full_name }}
    </h5>
    <div class="user-profile">
                    <span>{{ user.first_name }} <br> 
                    <span style="font-size: 12px; color: green;">(Parent)</span>
                  </span>
                    <div class="user-profile" id="userProfileDropdown">
                        <div class="user-avatar" id="userAvatarBtn">
                           {% if user.profile.display_avatar %}
  <img src="{{ user.profile.display_avatar }}" 
       alt="User Avatar"
       class="rounded-circle"
       style="width:40px; height:40px; object-fit:cover;">
{% else %}
  <div class="rounded-circle bg-primary text-white d-flex justify-content-center align-items-center"
       style="width:40px; height:40px; font-weight:bold; font-size:18px;">
    {{ user.first_name|default:user.username|first|upper }}
  </div>
{% endif %}

                        </div>
                        <div class="avatar-dropdown-menu" id="avatarDropdownMenu">
                            <a href="{% url 'accounts:settings' %}"><i class="fas fa-cog"></i> Settings</a>
                            {% if user.role == "teacher" %}
    <a href="{% url 'teachers:dashboard' %}"><i class="fas fa-home"></i> Home</a>
  {% elif user.role == "student" %}
    <a href="{% url 'students:dashboard' %}"><i class="fas fa-home"></i> Home</a>
  {% elif user.role == "parent" %}
    <a href="{% url 'parents:dashboard' %}"><i class="fas fa-home"></i> Home</a>
  {% elif user.is_superuser %}
    <a href="{% url 'admin:index' %}"><i class="fas fa-home"></i> Home</a>
  {% else %}
    <a href="{% url 'dashboard' %}"><i class="fas fa-home"></i> Home</a>
  {% endif %}
                            <a href="{% url 'account_logout' %}"><i class="fas fa-sign-out-alt"></i> Logout</a>
                        </div>
                    </div>
                </div>
  </div>

  <!-- Main Content -->
 <div class="container mt-2">

  <!-- Enrolled Classes (table) -->
  <div class="card section-card shadow-sm mb-4 border-0 rounded-3">
    <div class="card-header bg-primary text-white d-flex align-items-center">
      <i class="bi bi-journal-bookmark me-2"></i>
      <h5 class="mb-0">Enrolled Classes</h5>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th scope="col">Class</th>
              <th scope="col">Subject</th>
              <th scope="col">Section</th>
              <th scope="col">Teacher</th>
              <th scope="col" class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for c in classes %}
              <tr>
                <td>
                  <i class="bi bi-book text-success me-2"></i>
                  <strong>{{ c.class_name }}</strong>
                </td>
                <td class="text-muted">{{ c.subject_name }}</td>
                <td class="nowrap">{{ c.section }}</td>
                <td class="text-primary">üë®‚Äçüè´ {{ c.teacher.get_full_name }}</td>
                <td class="text-end">
                  <!-- Replace href with message link when available -->
                 <a href="{% url 'parents:conversation' c.teacher.id %}" 
   class="btn btn-sm btn-outline-primary" 
   title="Message Teacher">
  <i class="bi bi-chat-dots"></i> Message
</a>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="5" class="text-muted">No classes enrolled</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

 <!-- Assignments (table) -->
<div class="card section-card shadow-sm mb-4 border-0 rounded-3">
  <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
    <div>
      <i class="bi bi-pencil-square me-2"></i>
      <h5 class="mb-0 d-inline">Assignments</h5>
    </div>
    <div class="btn-group btn-group-sm" role="group" aria-label="Assignment filters">
      <a href="?filter=all" class="btn btn-outline-dark {% if filter == 'all' %}active{% endif %}">All</a>
      <a href="?filter=with_grade" class="btn btn-outline-success {% if filter == 'with_grade' %}active{% endif %}">With Grade</a>
      <a href="?filter=missing" class="btn btn-outline-danger {% if filter == 'missing' %}active{% endif %}">Missing</a>
    </div>
  </div>

  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover table-sm align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Assignment</th>
            <th>Class / Teacher</th>
            <th class="nowrap">Uploaded</th>
            <th class="nowrap">Submitted</th>
            <th class="text-center">Grade</th>
            <th>Status</th>
            <th class="text-end">Total Points</th> <!-- ‚úÖ Added column -->
          </tr>
        </thead>
        <tbody>
          {% for sub in submissions %}
            <tr>
              <td>
                <i class="bi bi-file-earmark-text text-secondary me-2"></i>
                <strong>{{ sub.assignment.title }}</strong>
              </td>
              <td>
                <div class="text-primary">{{ sub.assignment.class_obj.class_name }} ‚Äî {{ sub.assignment.class_obj.section }}</div>
                <small class="text-muted">Teacher: {{ sub.assignment.class_obj.teacher.get_full_name }}</small>
              </td>
              <td class="nowrap"><small class="text-muted">{{ sub.assignment.created_at|date:"M d, Y H:i" }}</small></td>
              <td class="nowrap">
                {% if sub.submitted_at %}
                  <small class="text-muted">{{ sub.submitted_at|date:"M d, Y H:i" }}</small>
                {% else %}
                  <small class="text-danger">Not submitted</small>
                {% endif %}
              </td>
              <td class="text-center">
                {% if sub.display_grade == 0 %}
                  <span class="text-danger">0</span>
                {% else %}
                  <span class="text-success">{{ sub.display_grade }}</span>
                {% endif %}
              </td>
              <td>
                {% if sub.is_returned %}
                  <span class="badge bg-info">Returned</span>
                {% elif sub.display_grade == 0 %}
                  <span class="badge bg-danger">Missing</span>
                {% else %}
                  <span class="badge bg-success">Graded</span>
                {% endif %}
              </td>
              <td class="text-end"> <!-- ‚úÖ connected to Assignment.points -->
                <strong>{{ sub.assignment.points|default:"‚Äî" }}</strong>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="7" class="text-muted">No submissions yet</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Quizzes and Exams Taken (table) -->
<div class="card section-card shadow-sm mb-4 border-0 rounded-3">
  <div class="card-header bg-success text-white d-flex align-items-center">
    <i class="bi bi-clipboard-check me-2"></i>
    <h5 class="mb-0">Quizzes and Exams Taken</h5>
  </div>

  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover table-sm align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Title</th>
            <th>Teacher</th>
            <th class="nowrap">Created</th>
            <th class="nowrap">Started</th>
            <th class="nowrap">Finished</th>
            <th class="text-end">Score</th>
            <th>Result</th>
          </tr>
        </thead>
        <tbody>
          {% for q in quizzes %}
            <tr>
              <td><strong>{{ q.quiz__title }}</strong></td>
              <td class="text-primary">{{ q.quiz__class_obj__teacher__first_name }} {{ q.quiz__class_obj__teacher__last_name }}</td>
              <td class="nowrap"><small class="text-muted">{{ q.quiz__created_at|date:"M d, Y H:i" }}</small></td>
              <td class="nowrap">
                {% if q.attempt__start_time %}
                  <small class="text-muted">{{ q.attempt__start_time|date:"M d, Y H:i" }}</small>
                {% else %}
                  <small class="text-muted">N/A</small>
                {% endif %}
              </td>
              <td class="nowrap">
                {% if q.attempt__submitted_at %}
                  <small class="text-muted">{{ q.attempt__submitted_at|date:"M d, Y H:i" }}</small>
                {% elif q.attempt__end_time %}
                  <small class="text-muted">{{ q.attempt__end_time|date:"M d, Y H:i" }} (Auto)</small>
                {% else %}
                  <small class="text-muted">N/A</small>
                {% endif %}
              </td>
              <td class="text-end">
                {% if q.display_score is not None %}
                  {{ q.display_score|floatformat:2 }} pts
                {% else %}
                  <small class="text-muted">‚Äî</small>
                {% endif %}
              </td>
              <td>
                {% if q.display_score >= 50 %}
                  <span class="badge bg-success rounded-pill">Passed</span>
                {% else %}
                  <span class="badge bg-danger rounded-pill">Failed</span>
                {% endif %}
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="7" class="text-muted">No quizzes taken yet</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

</div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // User avatar dropdown
const userAvatarBtn = document.getElementById("userAvatarBtn");
const avatarDropdownMenu = document.getElementById("avatarDropdownMenu");
const userProfileDropdown = document.getElementById("userProfileDropdown");

userAvatarBtn.addEventListener("click", function(e) {
    e.stopPropagation();
    avatarDropdownMenu.style.display = avatarDropdownMenu.style.display === "flex" ? "none" : "flex";
});

document.addEventListener("click", function(e) {
    if (!userProfileDropdown.contains(e.target)) {
        avatarDropdownMenu.style.display = "none";
    }
});
</script>
</body>
</html>
