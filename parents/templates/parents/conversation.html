{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CMU-LMS-STUDENT</title>
  <link rel="icon" type="image/x-icon" href="{% static 'images/cmu.jpg' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        
       .sidebar {
    width: 280px;
    background: linear-gradient(180deg, #1e40af, #3b82f6);
    color: #fff;
    height: 100vh;
    position: fixed;
    left: 0; top: 0;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    transition: width 0.28s cubic-bezier(.4,2,.7,.9);
    overflow: hidden;
}
.sidebar.closed {
    width: 65px;
}
.sidebar .logo {
    display: flex;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    background: rgba(255,255,255,0.1);
    transition: padding .3s;
}
.sidebar.closed .logo { padding: 20px 12px; }
.logo img {
    width: 40px; height: 40px; border-radius: 50%; margin-right: 12px; transition: margin 0.3s;
}
.sidebar.closed .logo img { margin-right: 0; }
.cmu-logo {
    color: #fff;
    font-weight: 700;
    font-size: 1rem;
    white-space: nowrap;
    transition: opacity 0.18s, width 0.18s;
}
.sidebar.closed .cmu-logo {
    opacity: 0;
    width: 0;
    overflow: hidden;
}

/* Nav styles */
.nav-menu { flex: 1; padding: 16px 0;}
.nav-item {
    display: flex; align-items: center; padding: 16px 24px;
    color: white; text-decoration: none;
    transition: all 0.22s;
    font-size: 0.97rem; font-weight: 500;
    white-space: nowrap;
}
.nav-item:hover, .nav-item.active {
            background: rgba(255,255,255,0.15);
            color: white; 
            transform: translateX(5px);
        }
.nav-item i { margin-right: 15px; color: white; min-width: 21px;}
.sidebar.closed .nav-item { justify-content: center; padding: 16px 0; }
.sidebar.closed .nav-item i { margin-right: 0;}
.sidebar.closed .nav-item .nav-label { display: none; }
.nav-item .nav-label { display: inline; transition: opacity 0.2s;}
/* Hide nav-label if sidebar closed */
.sidebar.closed .nav-item .nav-label { display: none; }

/* Dropdown and teaching */
.dropdown-container { position: relative; }
.sidebar.closed .dropdown-container .teaching-header { justify-content: center; }
.sidebar.closed .dropdown-arrow,
.sidebar.closed .class-count,
.sidebar.closed .teaching-content span,
.sidebar.closed .teaching-content .nav-label { display: none !important; }
.sidebar.closed .subjects-container { display: none !important; }
.teaching-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    cursor: pointer;
    transition: all 0.3s ease;
}
.teaching-header:hover { transform: translateY(-1px); }
.teaching-header.active { background: rgba(255,255,255,0.1); border-radius: 8px; }
.teaching-content { display: flex; align-items: center; color: white; }
.teaching-content i {
    width: 32px; height: 32px; border-radius: 50%; margin-right: 12px;
    display: flex; align-items: center; justify-content: center; font-size: 16px; color: white;
}
.dropdown-arrow { color: white; font-size: 14px; transition: transform 0.3s ease; }
.dropdown-arrow.rotated { transform: rotate(180deg); }
.subjects-container {
    overflow: hidden; transition: max-height 0.4s ease, opacity 0.3s ease; max-height: 0; opacity: 0; margin-top: 0;
}
.subjects-container.expanded { max-height: 500px; opacity: 1; margin-top: 12px; }
.subject-item {
    display: flex; align-items: center; background: transparent; margin-bottom: 8px; padding: 14px 16px; border-radius: 50px; cursor: pointer; transition: all 0.2s; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.3);
}
.subject-item:last-child { margin-bottom: 0; }
.subject-item:hover { background: rgba(255,255,255,0.1); transform: translateX(4px); box-shadow: 0 4px 12px rgba(0,0,0,0.1);}
.subject-avatar { width: 24px; height: 24px; border-radius: 50%; background: #74b9ff; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-weight: 600; font-size: 12px; color: white;}
.subject-content { flex: 1;}
.subject-name { color: white; font-weight: 600; font-size: 16px; margin: 0;}
.subject-details { color: rgba(255,255,255,0.7); font-size: 12px; margin: 2px 0 0 0;}
.class-count { background: rgba(255,255,255,0.2); color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; margin-left: 8px; }
.delete-subject-btn { background: rgba(220,38,38,0.8); color: white; border: none; width: 20px; height: 20px; border-radius: 50%; font-size: 14px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; margin-left: 8px;}
.delete-subject-btn:hover { background: rgba(220,38,38,1); transform: scale(1.1); }

/* Sidebar hover trigger area */
.sidebar-hover-area {
    position: fixed;
    left: 0; top: 0;
    width: 22px; height: 100vh;
    z-index: 1050;
    background: transparent;
}

/* Main content */
.main-content {
    margin-left: 280px;
    transition: margin-left 0.28s cubic-bezier(.4,2,.7,.9);
    height: 100vh;
    display: flex;
}
.sidebar.closed ~ .main-content {
    margin-left: 65px;
}
   /* Main Layout */
.main-content {
  height: 100vh;
  display: flex;
  background-color: #f8f9fa;
  overflow: hidden;
}

/* Sidebar */
.chat-sidebar {
  width: 300px;
  background-color: #fff;
  border-right: 1px solid #dee2e6;
  display: flex;
  flex-direction: column;
}

.chat-sidebar-header {
  padding: 1rem;
  color: black;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: 600;
}

.chat-contacts {
  flex: 1;
  overflow-y: auto;
}

.chat-contact {
  display: flex;
  align-items: center;
  padding: 0.75rem 1rem;
  text-decoration: none;
  color: #212529;
  transition: background 0.2s;
}

.chat-contact:hover {
  background-color: #f1f1f1;
}

.chat-contact.active {
  background-color: #e9ecef;
  font-weight: 600;
}

.chat-contact-name {
  font-size: 0.95rem;
}

/* Chat Main Section */
.chat-main {
  flex: 1;
  display: flex;
  flex-direction: column;
  background-color: #f8f9fa;
}

.chat-header {
  padding: 1rem;
  border-bottom: 1px solid #dee2e6;
  background-color: #fff;
}

.chat-header .fw-semibold {
  font-size: 1.1rem;
}

/* Chat Messages */
.chat-messages {
  flex: 1;
  padding: 1rem;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  background-color: #f5f6fa;
}

/* Message container */
.chat-message {
  max-width: 100%;
 
}

/* Message bubble */
.message-bubble {
  padding: 0.5rem 0.75rem;
  border-radius: 15px;
  font-size: 0.95rem;
  transition: background 0.2s;
}

.message-bubble.bg-primary {
  background-color: #6610f2 !important;
}

.message-bubble.bg-light {
  background-color: #e9ecef !important;
}

/* Message timestamp (hidden until clicked) */
.message-time {
  font-size: 0.8rem;
  color: #6c757d;
  margin-top: 3px;
}

/* Avatar */
.chat-avatar img,
.chat-contact-avatar img {
  border: 2px solid #dee2e6;
}

/* Chat Input */
.chat-input {
  display: flex;
  border-top: 1px solid #dee2e6;
  background-color: #fff;
  padding: 0.75rem;
  align-items: center;
}

.chat-input input {
  flex: 1;
  border: 1px solid #ced4da;
  border-radius: 20px;
  padding: 0.5rem 1rem;
  font-size: 0.95rem;
  outline: none;
}

.chat-input input:focus {
  border-color: #6610f2;
  box-shadow: 0 0 0 0.1rem rgba(102, 16, 242, 0.25);
}

.chat-input button {
  background-color: #537fee;
  color: white;
  border: none;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  margin-left: 0.5rem;
  display: flex;
  justify-content: center;
  align-items: center;
  transition: background 0.2s;
}

.chat-input button:hover {
  background-color: #250dc2;
}

/* Scrollbar Styling */
.chat-contacts::-webkit-scrollbar,
.chat-messages::-webkit-scrollbar {
  width: 8px;
}

.chat-contacts::-webkit-scrollbar-thumb,
.chat-messages::-webkit-scrollbar-thumb {
  background-color: #ccc;
  border-radius: 10px;
}

/* Responsive Design */
@media (max-width: 768px) {
  .chat-sidebar {
    width: 100px;
  }

  .chat-contact-name {
    display: none;
  }

  .chat-main {
    flex: 1;
  }
}




    </style>
</head>
<body>
    
       <!-- Sidebar -->
<div class="sidebar-hover-area" id="sidebarHoverArea"></div>
<!-- Sidebar -->
<div class="sidebar closed" id="sidebar">
    <div class="logo">
        <img src="{% static 'images/cmu.jpg' %}" alt="CMU Logo">
        <div class="cmu-logo">City of Malabon University</div>
    </div>
    <nav class="nav-menu">
        <a href="{% url 'parents:dashboard' %}" class="nav-item"><i class="fas fa-home"></i><span class="nav-label">Home</span></a>
        <a href="{% url 'parents:calendar' %}" class="nav-item"><i class="fas fa-calendar"></i><span class="nav-label">Event Calendar</span></a>
        <a href="{% url 'parents:announcements' %}" class="nav-item"><i class="fas fa-bullhorn"></i><span class="nav-label">Announcement</span></a>
        <a href="{% url 'parents:conversation'%}" class="nav-item"><i class="fas fa-comments"></i><span class="nav-label">Messages</span></a>
        <a href="{% url 'accounts:settings' %}" class="nav-item"><i class="fas fa-cog"></i><span class="nav-label">Settings</span></a>
        <a href="{% url 'account_logout' %}" class="nav-item"><i class="fas fa-sign-out-alt"></i><span class="nav-label">Logout</span></a>
    </nav>
</div>
<div class="d-flex main-content">

  <!-- Sidebar -->
  <div class="chat-sidebar">
    <div class="chat-sidebar-header">
      <span>Contacts</span>
    </div>

    <div class="p-2">
      <input type="text" id="contactSearch" class="form-control form-control-sm" placeholder="Search contact...">
    </div>

 <div class="chat-contacts" id="contactList">
  {% for contact in contacts %}
  <a href="{% url 'parents:conversation' contact.id %}"
   class="chat-contact {% if other_user and contact.id == other_user.id %}active{% endif %}">
      <div class="chat-contact-avatar me-2">
        {% if contact.profile_picture %}
          <img src="{{ contact.profile_picture.url }}" alt="{{ contact.get_full_name }}" 
               class="rounded-circle" style="width:45px; height:45px; object-fit:cover;">
        {% else %}
          <div class="rounded-circle bg-primary text-white d-flex justify-content-center align-items-center"
               style="width:45px; height:45px; font-weight:bold; font-size:18px;">
            {{ contact.get_full_name|first|upper }}
          </div>
        {% endif %}
      </div>
      <div class="chat-contact-name">{{ contact.get_full_name }}</div>
    </a>
  {% empty %}
    <p class="text-muted p-3">No contacts available.</p>
  {% endfor %}
</div>

  </div>

  <!-- Chat Main -->
  <div class="chat-main">
    {% if other_user %}
     <div class="chat-header d-flex align-items-center">
  <div class="chat-header-avatar me-2">
    {% if other_user.profile_picture %}
      <img src="{{ other_user.profile_picture.url }}" 
           alt="{{ other_user.get_full_name }}" 
           class="rounded-circle" 
           style="width:45px; height:45px; object-fit:cover;">
    {% else %}
      <div class="rounded-circle bg-primary text-white d-flex justify-content-center align-items-center"
           style="width:45px; height:45px; font-weight:bold; font-size:18px;">
        {{ other_user.get_full_name|first|upper }}
      </div>
    {% endif %}
  </div>
  <div>
    <div class="fw-semibold">{{ other_user.get_full_name }}</div>
    <div class="text-muted small">
      {% if other_user.is_active %}
        Online
      {% else %}
        Offline
      {% endif %}
    </div>
  </div>
</div>


     <div class="chat-messages">
  {% for msg in messages %}
    <div class="d-flex mb-2 {% if msg.sender == request.user %}justify-content-end{% else %}justify-content-start{% endif %}">
      
      {% if msg.sender != request.user %}
        <!-- Avatar for other user -->
        <div class="chat-avatar me-2 d-flex align-items-end">
          {% if msg.sender.profile_picture %}
            <img src="{{ msg.sender.profile_picture.url }}" 
                 alt="{{ msg.sender.get_full_name }}" 
                 class="rounded-circle" 
                 style="width:30px; height:30px; object-fit:cover;">
          {% else %}
            <div class="rounded-circle bg-primary text-white d-flex justify-content-center align-items-center"
                 style="width:30px; height:30px; font-size:14px; font-weight:bold;">
              {{ msg.sender.get_full_name|first|upper }}
            </div>
          {% endif %}
        </div>
      {% endif %}
      
      <!-- Message bubble + hidden time -->
      <div class="chat-message">
        <div class="p-2 rounded-3 message-bubble {% if msg.sender == request.user %}bg-primary text-white{% else %}bg-light{% endif %}" 
             style="max-width: 100%;cursor:pointer;"
             onclick="toggleTimestamp(this)">
          {{ msg.content }}
        </div>
        <div class="text-muted small mt-1 {% if msg.sender == request.user %}text-end{% endif %} message-time" style="display:none;">
          {{ msg.timestamp|date:"M d, Y H:i" }}
        </div>
      </div>

      {% if msg.sender == request.user %}
        <!-- Avatar for current user -->
        <div class="chat-avatar ms-2 d-flex align-items-end">
          {% if msg.sender.profile_picture %}
            <img src="{{ msg.sender.profile_picture.url }}" 
                 alt="{{ msg.sender.get_full_name }}" 
                 class="rounded-circle" 
                 style="width:30px; height:30px; object-fit:cover;">
          {% else %}
            <div class="rounded-circle bg-primary text-white d-flex justify-content-center align-items-center"
                 style="width:30px; height:30px; font-size:14px; font-weight:bold;">
              {{ msg.sender.get_full_name|first|upper }}
            </div>
          {% endif %}
        </div>
      {% endif %}
    </div>
  {% empty %}
    <p class="text-muted">No messages yet.</p>
  {% endfor %}
</div>





      <form method="post" class="chat-input">
        {% csrf_token %}
        <input type="text" name="content" placeholder="Type a message..." required>
        <button type="submit"><i class="fas fa-paper-plane"></i></button>
      </form>
    {% else %}
      <div class="p-5 text-center text-muted">Select a contact to start chatting</div>
    {% endif %}
  </div>
</div>

<!-- Add Contact Modal -->
<div class="modal fade" id="addContactModal" tabindex="-1" aria-labelledby="addContactModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" action="{}">
      {% csrf_token %}
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addContactModalLabel"><i class="fas fa-user-plus"></i> Add Contact</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <label class="form-label">Search by name or email</label>
          <input type="text" name="contact_query" class="form-control" placeholder="Enter name or email" required>
          <small class="text-muted">You can add classmates or parents as contacts.</small>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Contact</button>
        </div>
      </div>
    </form>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Toggle visibility of timestamp when message is clicked
  function toggleTimestamp(element) {
    const timeDiv = element.nextElementSibling;
    if (timeDiv.style.display === "none" || timeDiv.style.display === "") {
      // Hide all other timestamps
      document.querySelectorAll('.message-time').forEach(el => el.style.display = 'none');
      timeDiv.style.display = "block";
    } else {
      timeDiv.style.display = "none";
    }
  }
  // simple live search
  document.getElementById('contactSearch').addEventListener('input', function () {
    const query = this.value.toLowerCase();
    document.querySelectorAll('#contactList .chat-contact').forEach(el => {
      el.style.display = el.textContent.toLowerCase().includes(query) ? '' : 'none';
    });
  });

        // Sidebar open/close logic with hover area
const sidebar = document.getElementById('sidebar');
const hoverArea = document.getElementById('sidebarHoverArea');
let sidebarHovered = false;
let hoverTimeout = null;

function openSidebar() {
    sidebar.classList.remove('closed');
}
function closeSidebar() {
    sidebar.classList.add('closed');
    // Close dropdown if open
    const subjectsContainer = document.getElementById('subjectsContainer');
    const dropdownArrow = document.getElementById('dropdownArrow');
    subjectsContainer.classList.remove('expanded');
    dropdownArrow.classList.remove('rotated');
}

sidebar.addEventListener('mouseenter', () => {
    sidebarHovered = true;
    openSidebar();
    if (hoverTimeout) clearTimeout(hoverTimeout);
});
sidebar.addEventListener('mouseleave', () => {
    sidebarHovered = false;
    hoverTimeout = setTimeout(() => {
        if (!sidebarHovered) closeSidebar();
    }, 150);
});
hoverArea.addEventListener('mouseenter', () => {
    sidebarHovered = true;
    openSidebar();
    if (hoverTimeout) clearTimeout(hoverTimeout);
});
hoverArea.addEventListener('mouseleave', () => {
    sidebarHovered = false;
    hoverTimeout = setTimeout(() => {
        if (!sidebarHovered) closeSidebar();
    }, 150);
});



    </script>
</body>
</html>