{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CMU-LMS-TEACHER</title>
  <link rel="icon" type="image/x-icon" href="{% static 'images/cmu.jpg' %}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <style>
    body {
      background: linear-gradient(120deg, #f7f8fa 0%, #eef2fb 100%);
      font-family: 'Google Sans', 'Roboto', Arial, sans-serif;
      color: #2e3440;
      min-height: 100vh;
    }
    .gclass-assignment-header {
      display: flex; align-items: center; gap: 14px; padding: 18px 38px; background: linear-gradient(90deg, #6366f1 70%, #204ecf 100%);
      border-bottom: none; border-radius: 0 0 20px 20px; box-shadow: 0 2px 24px rgba(60,80,120,.08);
      position: relative; color: #fff;
    }
    .gclass-assignment-header .close-btn {
      background: none; border: none; color: #fff; font-size: 1.5rem;
      margin-right: 8px; cursor: pointer; border-radius: 50%; transition: background 0.17s;
      width: 42px; height: 42px; display: flex; justify-content: center; align-items: center;
    }
    .gclass-assignment-header .close-btn:hover { background: #4751d7; }
    .gclass-assignment-header h2 { font-size: 1.6rem; font-weight: 700; margin-bottom: 0; letter-spacing: 0.5px;}
    .gclass-main {
      display: flex; gap: 32px; min-height: 80vh; max-width: 1300px; margin: 30px auto 0 auto; background: none;
    }
    .gclass-left, .gclass-right {
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 2px 18px rgba(60,80,120,.10);
    }
    .gclass-left { flex: 1.4; padding: 32px 24px 32px 32px; }
    .gclass-right {
      width: 380px;
      border-left: none;
      border-radius: 18px;
      box-shadow: 0 2px 18px rgba(60,80,120,.10);
      padding: 40px 32px 32px 32px;
      min-height: 100%;
      transition: box-shadow .2s;
      position: sticky;
      top: 24px;
      z-index: 2;
    }
    .gclass-card {
      background: #fff; border-radius: 16px; box-shadow: 0 4px 16px rgba(34,60,80,0.09); padding: 0;
      margin-bottom: 28px; border: 1px solid #e2e7ef; transition: box-shadow 0.2s;
      animation: fadeIn .4s;
    }
    @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }
    .gclass-form-group { padding: 28px 26px 18px 26px; border-bottom: 1px solid #ececec; }
    .gclass-title-input {
      background: #e3e8ef; border: none; border-bottom: 2px solid #e57373; font-size: 1.25rem; font-weight: 500;
      padding: 18px 14px; width: 100%; border-radius: 7px 7px 0 0; outline: none; margin-bottom: 10px;
      transition: border-color .2s;
    }
    .gclass-title-input:focus { border-bottom: 2.5px solid #6366f1; }
    .gclass-title-required { font-size: 1rem; color: #d32f2f; margin-left: 3px; }
    .gclass-instructions {
      background: #f3f5f8; border: none; font-size: 1.08rem; padding: 20px 12px; min-height: 120px; border-radius: 7px;
      width: 100%; resize: vertical; margin-bottom: 6px;
    }
    .gclass-editor-toolbar {
      display: flex; gap: 20px; margin-bottom: 12px; margin-left: 2px;
    }
    .gclass-editor-toolbar button {
      background: none; border: none; color: #757575; font-size: 1.1rem; padding: 0 2px; cursor: pointer;
      transition: color 0.2s;
    }
    .gclass-editor-toolbar button:hover { color: #6366f1; }
    .gclass-attach-group { padding: 18px 26px; }
    .gclass-attach-label { font-weight: 600; color: #4751d7; margin-bottom: 13px; font-size: 1.09rem;}
    .gclass-attach-icons { display: flex; gap: 30px; align-items: center; margin-top: 8px;}
    .gclass-attach-icon { display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 1.05rem; color: #495057; cursor: pointer; transition: background 0.2s;}
    .gclass-attach-icon .icon-bg {
      background: #f7fafd; border-radius: 50%; width: 46px; height: 46px; display: flex; align-items: center; justify-content: center;
      margin-bottom: 2px; border: 1.3px solid #e3e8ef; transition: border 0.2s;
    }
    .gclass-attach-icon:hover .icon-bg { border: 1.6px solid #6366f1; background: #e3e8ef; }
    /* Attachment preview cards */
    #attachmentList .preview-card {
      background: #f3f5f8;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(60,80,120,0.07);
      padding: 10px;
      position: relative;
      width: 130px;
      margin-right: 10px;
      margin-bottom: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #attachmentList .preview-card img {
      width:100px; height:70px; object-fit:cover; border-radius:6px;
      margin-bottom:6px;
    }
    #attachmentList .preview-card .btn {
      position: absolute; top: 7px; right: 7px; padding: 0 7px;
    }
    .chip {
      display: inline-block; background: #e3e8ef; color: #6366f1; border-radius: 12px; padding: 4px 10px; margin: 3px 4px; font-size: .98rem;
      box-shadow: 0 1px 3px rgba(60,80,120,0.03);
    }
    .chip .fa { color: #4751d7; }
    .gclass-right label, .gclass-right .form-label { font-weight: 600; color: #4751d7; margin-top: 18px; margin-bottom: 7px; }
    .gclass-right .input-group-text {
      border-radius: 7px 0 0 7px;
      border: none;
      font-size: 1.1rem;
      background: #f3f5f8;
      color: #6366f1;
    }
    .gclass-right .form-control, .gclass-right .form-select {
      border-radius: 0 7px 7px 0;
      border: none;
      box-shadow: 0 1px 4px rgba(60,80,120,0.04);
      background: #f3f5f8;
      font-size: 1.08rem;
      transition: box-shadow .2s;
    }
    .gclass-right .form-control:focus, .gclass-right .form-select:focus {
      outline: none;
      box-shadow: 0 0 0 2px #6366f1;
      border: none;
    }
    .gclass-right .border-bottom { border-color: #e3e8ef !important; }
    .assign-btn {
      background: linear-gradient(90deg, #6366f1 60%, #204ecf 100%);
      color: #fff;
      font-size: 1.15rem;
      border-radius: 24px;
      font-weight: 600;
      border: none;
      padding: 14px 40px;
      width: 100%;
      box-shadow: 0 2px 8px rgba(34,60,80,0.12);
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      transition: background 0.2s, box-shadow 0.2s;
      margin-top: 22px;
    }
    .assign-btn:hover {
      background: linear-gradient(90deg, #204ecf 0%, #6366f1 100%);
      box-shadow: 0 4px 12px rgba(34,60,80,0.14);
    }
    .gclass-right .all-students-btn {
      background: none; border: 1.5px solid #6366f1; color: #6366f1; border-radius: 25px; padding: 8px 0; font-weight: 500;
      margin-bottom: 10px; width: 100%; display: flex; align-items: center; gap: 9px; justify-content: center;
      transition: background 0.2s, color 0.2s;
    }
    .gclass-right .all-students-btn:hover { background: #e3e8ef; color: #4751d7; border-color: #4751d7;}
    /* Responsive */
    @media (max-width: 900px) {
      .gclass-main { flex-direction: column; gap: 18px;}
      .gclass-right {
        width: 100%;
        border-radius: 12px;
        box-shadow: 0 2px 9px rgba(40,60,120,.10);
        padding: 24px 12px;
        margin-top: 18px;
        min-height: auto;
      }
    }
    @media (max-width: 600px) {
      .gclass-assignment-header { padding: 14px 10px;}
      .gclass-main { padding: 0 2vw;}
      .gclass-left, .gclass-right, .gclass-card { border-radius: 10px;}
    }


    #attachmentDropArea {
  transition: border-color 0.2s, background 0.2s;
  border: 2px dashed #6366f1;
}
#attachmentDropArea.dragover {
  border-color: #204ecf;
  background: #e3e8ef;
}
.preview-card {
  background: #f3f5f8;
  border-radius: 8px;
  box-shadow: 0 1px 4px rgba(60,80,120,0.07);
  padding: 10px;
  position: relative;
  width: 140px;
  margin-right: 10px;
  margin-bottom: 10px;
  display: flex;
  flex-direction: column;
  align-items: center;
}
.preview-card img {
  width:100px; height:70px; object-fit:cover; border-radius:6px; margin-bottom:6px;
}
.preview-card .btn {
  position: absolute; top: 7px; right: 7px; padding: 0 7px;
}
.file-info {
  font-size: 0.9em;
  color: #495057;
  margin-bottom: 3px;
  text-align: center;
}
  </style>
</head>
<body>
  <!-- Toasts -->
  <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index:2000;">
    <div id="formToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">Assignment submitted successfully!</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>
  <!-- Header -->
  <div class="gclass-assignment-header">
    <button class="close-btn" onclick="window.history.back()" aria-label="Back">
      <i class="fas fa-times" aria-hidden="true"></i>
    </button>
    <i class="fas fa-clipboard-list"></i>
    <h2>Assignment</h2>
    <div class="ms-auto">
      <button type="button" class="btn btn-primary px-4 py-2 rounded-pill shadow-sm" id="assignButton">
        <i class="fas fa-paper-plane me-2"></i> Assign
      </button>
    </div>
  </div>
  <!-- Main Content -->
  <form id="gclassAssignmentForm" method="POST" enctype="multipart/form-data" autocomplete="off">
    {% csrf_token %}
    <div class="gclass-main">
      <!-- Left Section -->
      <div class="gclass-left">
        <div class="gclass-card">
          <div class="gclass-form-group">
            <input type="text" class="gclass-title-input" id="assignmentTitle" name="title" required maxlength="100" placeholder="Title*">
            <div class="gclass-title-required mb-2 ms-1">*Required</div>
            <label for="assignmentInstructions" class="form-label mt-3 mb-1">Instructions (optional)</label>
            <div class="gclass-editor-toolbar">
              <button type="button" title="Bold"><i class="fas fa-bold"></i></button>
              <button type="button" title="Italic"><i class="fas fa-italic"></i></button>
              <button type="button" title="Underline"><i class="fas fa-underline"></i></button>
              <button type="button" title="List"><i class="fas fa-list-ul"></i></button>
              <button type="button" title="Strike"><i class="fas fa-strikethrough"></i></button>
            </div>
            <textarea class="gclass-instructions" id="assignmentInstructions" name="instructions" rows="6"></textarea>
          </div>
        </div>
        <div class="gclass-card">
          <div class="gclass-attach-group">
            <div class="gclass-attach-label mb-2">Attachments</div>
            <div id="attachmentDropArea" class="border bg-light rounded p-4 text-center mb-2" tabindex="0" style="cursor:pointer;">
              <i class="fas fa-cloud-upload-alt fa-2x text-primary mb-2"></i>
              <div>Drop files here or <span class="text-primary text-decoration-underline" onclick="document.getElementById('fileInput').click()" style="cursor:pointer;">browse</span></div>
              <input type="file" name="attachment" id="fileInput" style="display:none;" multiple>
            </div>
            <div id="attachmentList" class="d-flex flex-wrap gap-2"></div>
            <small class="text-muted">Supported: Images, PDF, Word. Max 5 files, 10MB each.</small>
          </div>
        </div>
        <div class="gclass-card">
          <div class="gclass-attach-group pb-2">
            <div class="gclass-attach-label mb-2">Links & Media</div>
            <div id="youtubePreviewContainer" class="mb-2"></div>
            <div id="attachedLinksContainer"></div>
            <input type="hidden" name="attached_links" id="attachedLinksInput">
            <div class="gclass-attach-icons mt-2">
              <div class="gclass-attach-icon" title="Drive">
                <div class="icon-bg"><img src="{% static 'images/gdrive.webp' %}" alt="Drive" style="width:28px;"></div>
                <span>Drive</span>
              </div>
              <div class="gclass-attach-icon" title="YouTube" data-bs-toggle="modal" data-bs-target="#youtubeModal">
                <div class="icon-bg"><img src="{% static 'images/youtube.png' %}" alt="YouTube" style="width:28px;"></div>
                <span>YouTube</span>
              </div>
              <div class="gclass-attach-icon" title="Link" data-bs-toggle="modal" data-bs-target="#addLinkModal">
                <div class="icon-bg"><i class="fas fa-link" style="font-size:22px; color:#6366f1;"></i></div>
                <span>Link</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Right Section -->
      <div class="gclass-right shadow sticky-top" style="top: 24px; z-index:2;">
        <div class="mb-3 pb-2 border-bottom">
          <label for="classFor" class="form-label"><i class="fa fa-chalkboard me-2 text-primary"></i>For</label>
          <select id="classFor" name="class_for" class="form-select mb-2">
            {% for class in classes %}
              <option value="{{ class.id }}">{{ class.class_name }} {{ class.section }}</option>
            {% empty %}
              <option disabled>No classes found</option>
            {% endfor %}
          </select>
        </div>
        <div class="mb-3 pb-2 border-bottom">
          <label class="form-label"><i class="fas fa-users me-2 text-primary"></i>Assign to</label>
          <button type="button" class="all-students-btn" data-bs-toggle="modal" data-bs-target="#assignToModal">
            <i class="fas fa-users"></i> Assign to
          </button>
        </div>
        <div class="mb-3 pb-2 border-bottom">
          <label for="assignmentPoints" class="form-label">
            <i class="fas fa-star-half-alt me-2 text-warning"></i>Points
          </label>
          <div class="input-group">
            <span class="input-group-text bg-white text-warning"><i class="fas fa-star"></i></span>
            <input type="number" id="assignmentPoints" name="points" class="form-control" min="0" value="100" style="max-width:120px;">
          </div>
        </div>
        <div class="mb-3 pb-2 border-bottom">
          <label for="assignmentDueDate" class="form-label">
            <i class="fas fa-calendar-alt me-2 text-primary"></i>Due date
          </label>
          <div class="input-group">
            <span class="input-group-text bg-white text-primary"><i class="fas fa-calendar-day"></i></span>
            <input type="date" id="assignmentDueDate" name="due_date" class="form-control">
          </div>
        </div>
        <div class="mb-2">
          <label for="assignmentDueTime" class="form-label">
            <i class="fas fa-clock me-2 text-primary"></i>Due time
          </label>
          <div class="input-group">
            <span class="input-group-text bg-white text-primary"><i class="fas fa-clock"></i></span>
            <input type="time" id="assignmentDueTime" name="due_time" class="form-control">
          </div>
        </div>
      </div>
    </div>
  </form>
  <!-- Modals (keep your existing modals unchanged) -->
  {{ modals|safe }}
  <!-- Your existing modals code here... -->
    <!-- Assign to Students Modal -->
<div class="modal fade" id="assignToModal" tabindex="-1" aria-labelledby="assignToModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="assignToModalLabel">Assign to</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
   

     <div class="modal-body">
  {% if students %}
    <div class="list-group">
      <!-- All Students -->
      <label class="list-group-item d-flex align-items-center fw-bold">
        <input class="form-check-input me-2" type="checkbox" id="selectAllStudents" name="assign_all" value="1">
        All Students
      </label>

      <!-- Individual Students -->
      {% for student in students %}
        <label class="list-group-item d-flex align-items-center">
          <input class="form-check-input me-2 student-check" type="checkbox" name="students" value="{{ student.id }}">
          {{ student.get_full_name }}
        </label>
      {% endfor %}
    </div>
  {% else %}
    <p class="text-muted">No students found in this class.</p>
  {% endif %}
</div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveSelectedStudents()">Done</button>
      </div>
    </div>
  </div>
</div>
<!-- YouTube Modal -->
<div class="modal fade" id="youtubeModal" tabindex="-1" aria-labelledby="youtubeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content border-0 shadow-lg rounded-4">
      
      <!-- Header -->
      <div class="modal-header bg-danger text-white rounded-top-4">
        <h5 class="modal-title" id="youtubeModalLabel">
          <i class="fab fa-youtube me-2"></i>Add YouTube Video
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- Body -->
      <div class="modal-body">
        <label for="youtubeUrlInput" class="form-label fw-semibold">Paste your YouTube link:</label>
        <input 
          type="url" 
          id="youtubeUrlInput" 
          class="form-control" 
          placeholder="https://www.youtube.com/watch?v=example"
          required
        >
        <div id="youtubeModalPreview" class="mt-3"></div>
      </div>

      <!-- Footer -->
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn btn-danger rounded-pill px-4" id="youtubeAddBtn">
          Add Video
        </button>
      </div>

    </div>
  </div>
</div>
<!-- Link Modal -->
<div class="modal fade" id="addLinkModal" tabindex="-1" aria-labelledby="addLinkModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg rounded-4">
      <div class="modal-header bg-primary text-white rounded-top-4">
        <h5 class="modal-title" id="addLinkModalLabel"><i class="fas fa-link me-2"></i>Add a Link</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <label for="linkInput" class="form-label fw-semibold">Paste your link here:</label>
        <input type="url" id="linkInput" class="form-control" placeholder="https://example.com" required>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary rounded-pill px-4" id="saveLinkBtn">Add Link</button>
      </div>
    </div>
  </div>
</div>
<!-- Schedule Assignment Modal -->
<div class="modal fade" id="scheduleModal" tabindex="-1" aria-labelledby="scheduleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg rounded-4">
      <div class="modal-header bg-primary text-white rounded-top-4">
        <h5 class="modal-title" id="scheduleModalLabel"><i class="fas fa-clock me-2"></i>Schedule Assignment</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <p class="text-secondary mb-3">Would you like to assign this now or schedule it for later?</p>

        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" name="assignOption" id="assignNow" value="now" checked>
          <label class="form-check-label" for="assignNow">Assign now</label>
        </div>

        <div class="form-check mb-3">
          <input class="form-check-input" type="radio" name="assignOption" id="assignLater" value="schedule">
          <label class="form-check-label" for="assignLater">Schedule for later</label>
        </div>

        <div id="scheduleFields" style="display:none;">
          <label for="scheduleDate" class="form-label">Schedule Date</label>
          <input type="date" id="scheduleDate" name="schedule_date" class="form-control mb-3">
          <label for="scheduleTime" class="form-label">Schedule Time</label>
          <input type="time" id="scheduleTime" name="schedule_time" class="form-control">
        </div>
      </div>

      <div class="modal-footer border-0">
        <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary rounded-pill px-4" id="confirmAssignBtn">
          Confirm
        </button>
      </div>
    </div>
  </div>
</div>
  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
   const dropArea = document.getElementById('attachmentDropArea');
const fileInput = document.getElementById('fileInput');
const attachmentList = document.getElementById('attachmentList');
let files = [];

dropArea.addEventListener('click', () => fileInput.click());
dropArea.addEventListener('dragover', (e) => {
  e.preventDefault();
  dropArea.classList.add('dragover');
});
dropArea.addEventListener('dragleave', () => {
  dropArea.classList.remove('dragover');
});
dropArea.addEventListener('drop', (e) => {
  e.preventDefault();
  dropArea.classList.remove('dragover');
  handleFiles(e.dataTransfer.files);
});
fileInput.addEventListener('change', () => {
  handleFiles(fileInput.files);
});

function handleFiles(selectedFiles) {
  for (let file of selectedFiles) {
    if (files.length >= 5) {
      alert("Maximum 5 files allowed."); break;
    }
    if (file.size > 10 * 1024 * 1024) {
      alert("File too large: " + file.name); continue;
    }
    files.push(file);
  }
  renderAttachmentPreviews();
  updateFileInput();
}

function renderAttachmentPreviews() {
  attachmentList.innerHTML = '';
  files.forEach((file, index) => {
    const card = document.createElement('div');
    card.className = 'preview-card';
    let preview = '';
    if (file.type.startsWith('image/')) {
      const reader = new FileReader();
      reader.onload = e => {
        preview = `<img src="${e.target.result}" alt="${file.name}">`;
        card.innerHTML = preview + `
          <div class="file-info">${file.name}<br>${Math.round(file.size/1024)} KB</div>
          <button type="button" class="btn btn-sm btn-outline-danger" aria-label="Remove">&times;</button>
        `;
        card.querySelector('button').addEventListener('click', () => {
          files.splice(index, 1);
          renderAttachmentPreviews();
          updateFileInput();
        });
      };
      reader.readAsDataURL(file);
    } else {
      let icon = '<i class="fas fa-file-alt fa-2x text-secondary mb-1"></i>';
      if (file.type === 'application/pdf') icon = '<i class="fas fa-file-pdf fa-2x text-danger mb-1"></i>';
      if (file.name.match(/\.(doc|docx)$/)) icon = '<i class="fas fa-file-word fa-2x text-primary mb-1"></i>';
      card.innerHTML = icon + `
        <div class="file-info">${file.name}<br>${Math.round(file.size/1024)} KB</div>
        <button type="button" class="btn btn-sm btn-outline-danger" aria-label="Remove">&times;</button>
      `;
      card.querySelector('button').addEventListener('click', () => {
        files.splice(index, 1);
        renderAttachmentPreviews();
        updateFileInput();
      });
    }
    attachmentList.appendChild(card);
  });
}

function updateFileInput() {
  const dataTransfer = new DataTransfer();
  files.forEach(file => dataTransfer.items.add(file));
  fileInput.files = dataTransfer.files;
}
    // Link attach logic
    const linkInput = document.getElementById("linkInput");
    const attachedLinksContainer = document.getElementById("attachedLinksContainer");
    const attachedLinksInput = document.getElementById("attachedLinksInput");
    let attachedLinks = [];
    document.getElementById("saveLinkBtn").addEventListener("click", function () {
      const link = linkInput.value.trim();
      if (link) {
        attachedLinks.push(link);
        renderAttachedLinks();
        linkInput.value = "";
        const modal = bootstrap.Modal.getInstance(document.getElementById("addLinkModal"));
        modal.hide();
      } else {
        alert("Please paste a valid link.");
      }
    });
    function renderAttachedLinks() {
      attachedLinksContainer.innerHTML = attachedLinks
        .map(
          (link, index) => `
            <span class="chip"><i class="fas fa-link me-1"></i>
              <a href="${link}" target="_blank" class="text-decoration-none text-primary">${link}</a>
              <button type="button" class="btn btn-xs btn-link text-danger p-0 ms-1" onclick="removeLink(${index})"><i class="fas fa-times"></i></button>
            </span>
          `
        )
        .join("");
      attachedLinksInput.value = JSON.stringify(attachedLinks);
    }
    window.removeLink = function(index) {
      attachedLinks.splice(index, 1);
      renderAttachedLinks();
    };
    // YouTube preview logic
    function fetchOEmbed(url) {
      return fetch(`https://www.youtube.com/oembed?url=${encodeURIComponent(url)}&format=json`)
        .then(res => { if (!res.ok) throw new Error("Invalid link"); return res.json(); });
    }
    const youtubeUrlInput = document.getElementById("youtubeUrlInput");
    const youtubeModalPreview = document.getElementById("youtubeModalPreview");
    const youtubeAddBtn = document.getElementById("youtubeAddBtn");
    const previewContainer = document.getElementById("youtubePreviewContainer");
    const form = document.getElementById("gclassAssignmentForm");
    youtubeUrlInput.addEventListener("input", function(){
      const url = this.value.trim();
      youtubeModalPreview.innerHTML = "";
      if (!url) return;
      fetchOEmbed(url)
        .then(data => {
          youtubeModalPreview.innerHTML = `
            <div class="card">
              <img src="${data.thumbnail_url}" class="card-img-top" alt="YouTube Thumbnail">
              <div class="card-body">
                <h5 class="card-title">${data.title}</h5>
                <p class="card-text">By ${data.author_name}</p>
              </div>
            </div>
          `;
        })
        .catch(()=> youtubeModalPreview.innerHTML = `<p class="text-danger">Invalid YouTube link</p>`);
    });
    youtubeAddBtn.addEventListener("click", function(){
      const url = youtubeUrlInput.value.trim();
      if (!url) return;
      fetchOEmbed(url)
        .then(data => {
          const hidden = document.createElement("input");
          hidden.type = "hidden";
          hidden.name = "youtube_urls";
          hidden.value = url;
          form.appendChild(hidden);
          const chip = document.createElement("span");
          chip.className = "chip";
          chip.innerHTML = `
            <img src="${data.thumbnail_url}" alt="YouTube" style="width:30px;height:30px;border-radius:5px;vertical-align:middle;margin-right:5px;">
            <span title="${data.title}">${data.title}</span>
            <button type="button" class="btn btn-xs btn-link text-danger p-0 ms-1">&times;</button>
          `;
          chip.querySelector("button").addEventListener("click", function(){
            hidden.remove();
            chip.remove();
          });
          previewContainer.appendChild(chip);
          youtubeUrlInput.value = "";
          youtubeModalPreview.innerHTML = "";
          bootstrap.Modal.getInstance(document.getElementById("youtubeModal")).hide();
        });
    });
    // Student assign logic
    window.saveSelectedStudents = function() {
      let selected = [];
      document.querySelectorAll('input[name="students"]:checked').forEach(el => {
        selected.push(el.value);
      });
      let btn = document.querySelector('.all-students-btn');
      if (selected.length > 0) {
        btn.innerHTML = `<i class="fas fa-users"></i> ${selected.length} selected`;
      } else {
        btn.innerHTML = `<i class="fas fa-users"></i> All students`;
      }
      let modal = bootstrap.Modal.getInstance(document.getElementById('assignToModal'));
      modal.hide();
    };
    document.addEventListener("DOMContentLoaded", function() {
      const selectAll = document.getElementById("selectAllStudents");
      const studentChecks = document.querySelectorAll(".student-check");
      if (selectAll) {
        selectAll.addEventListener("change", function() {
          studentChecks.forEach(cb => cb.checked = selectAll.checked);
        });
      }
      studentChecks.forEach(cb => {
        cb.addEventListener("change", function() {
          const allChecked = Array.from(studentChecks).every(cb => cb.checked);
          selectAll.checked = allChecked;
        });
      });
    });
    // Assign/schedule logic
    document.getElementById("assignButton").addEventListener("click", function() {
      const modal = new bootstrap.Modal(document.getElementById("scheduleModal"));
      modal.show();
    });
    document.querySelectorAll('input[name="assignOption"]').forEach(radio => {
      radio.addEventListener("change", function() {
        const scheduleFields = document.getElementById("scheduleFields");
        scheduleFields.style.display = document.getElementById("assignLater").checked ? "block" : "none";
      });
    });
    document.getElementById("confirmAssignBtn").addEventListener("click", function() {
      const assignNow = document.getElementById("assignNow").checked;
      const scheduleDate = document.getElementById("scheduleDate").value;
      const scheduleTime = document.getElementById("scheduleTime").value;
      if (!assignNow) {
        if (!scheduleDate || !scheduleTime) {
          alert("Please select a valid date and time for scheduling."); return;
        }
        let hiddenInput = document.createElement("input");
        hiddenInput.type = "hidden";
        hiddenInput.name = "scheduled";
        hiddenInput.value = "true";
        form.appendChild(hiddenInput);
      }
      bootstrap.Modal.getInstance(document.getElementById("scheduleModal")).hide();
      form.submit();
      setTimeout(() => { new bootstrap.Toast(document.getElementById('formToast')).show(); }, 500);
    });
  </script>
</body>
</html>