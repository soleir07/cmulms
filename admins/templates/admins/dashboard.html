{% load static %} 
<!DOCTYPE html> 
<html lang="en"> 
<head> 
  <meta charset="UTF-8"> 
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <title>School Admin Dashboard | CMU LMS</title> 
  <!-- Bootstrap CSS --> 
   <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" 
   rel="stylesheet"> 
   <!-- Google Fonts & Icons --> 
    <link href="https://fonts.googleapis.com/css?family=Inter:400,600,700&display=swap" rel="stylesheet"> 
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"> 
    <!-- Custom CSS --> 
     <link rel="stylesheet" href="{% static 'admins/dashboard.css' %}"> 
     <!-- Chart.js --> 
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> 
      <style> body { 
        background: #f6f8fb; font-family: 'Inter', Arial, sans-serif; 
        } 
        .logo img { 
          width: 44px; 
          height: 44px; 
          margin-right: 12px; 
          border-radius: 50%; 
          box-shadow:0 2px 6px rgba(0,0,0,.08); 
          } 
          .navbar { 
            background: linear-gradient(90deg, #2E3B55 0%, #3F51B5 100%); 
          } 
          .navbar-brand { 
            font-weight: 700; font-size: 1.4rem; letter-spacing: .5px; } 
          .sidebar { min-height: 100vh; border-radius: 0 1.5rem 1.5rem 0; box-shadow: 2px 0 8px rgba(44,62,80,.06); } 
          .nav-link { 
            font-size: 1.08rem; 
            color: #374151; 
            padding: .85rem 1.3rem; 
            border-radius: 8px; 
            transition: background .2s, color .2s; 
            display: flex; align-items: center; gap: 8px; 
            } 
            .nav-link.active, .nav-link:hover { 
              background: #e3e9f9; color: #3F51B5; font-weight: 600; } 
              .card { border: none; background: #fff; box-shadow: 0 3px 16px 0 rgba(60,72,88,.08); transition: box-shadow .2s; } 
              .card:hover { box-shadow: 0 6px 24px 0 rgba(60,72,88,.12); } .card h3 { font-size: 2.4rem; color: #3F51B5; } 
              /* Responsive sidebar collapse button */ 
              @media (max-width: 991.98px) { 
                #sidebarMenu { border-radius: 0 0 1.5rem 1.5rem; } } 
                /* Custom dropdown avatar */ 
                .dropdown img { border: 2px solid #fff; box-shadow: 0 1px 4px rgba(60,72,88,.10); } 
                /* Chart card */ 
                .chart-card { min-height: 315px; } 
                /* Upcoming events style */ 
                .upcoming-event { padding: .7em 0; border-bottom: 1px solid #f1f1f1; 
                font-size: 1.07rem; color: #2E3B55; display: flex; align-items: center; gap: 8px; } 
                .upcoming-event:last-child { border-bottom: none; } 
                .no-event { color: #a8adb5; font-style: italic; font-size: 1rem; margin-top: 1em; } 
                .stat-icon { font-size: 2.2rem; vertical-align: middle; margin-right: 0.5em; color: #3F51B5; opacity: .85; } 
                /*new chart design*/ /* ...your existing styles ... */ 
                .chart-card { 
                  min-height: 315px; 
                  position: relative; 
                  overflow: hidden; 
                  background: linear-gradient(120deg, #e3e9f9 70%, #fff 100%); 
                  box-shadow: 0 3px 16px 0 rgba(60,72,88,.10); 
                  transition: box-shadow .23s, transform .23s; }
                   .chart-card:hover { 
                    box-shadow: 0 8px 30px 0 rgba(60,72,88,.16), 0 3px 12px 0 rgba(124,58,237,0.05);
                     transform: translateY(-2px) scale(1.02); } 
                     .chart-bg-blob { 
                      content: ""; 
                     position: absolute; 
                     width: 240px; 
                     height: 240px; top: -80px; right: -80px; background: radial-gradient(circle, #7C3AED33 0%, #3F51B511 80%, transparent 100%); z-index: 0; pointer-events: none; animation: chartBlob 7s ease-in-out infinite alternate; 
                     } 
                     #userStatsChart { 
                      max-height: 240px; 
                      margin-top: 10px; 
                      } 
                      @keyframes chartBlob { 0% { transform: scale(1) rotate(0deg);} 100% { transform: scale(1.18) rotate(15deg);}
                       } 
                       .chart-controls .btn {
                        font-size: 1.2rem; }
</style>
</head> 
<body> 
  <!-- Top Navbar --> 
   <nav class="navbar navbar-expand-lg navbar-dark shadow-sm px-3"> 
    <div class="container-fluid"> 
      <div class="logo d-flex align-items-center"> 
        <img src="{% static 'images/cmu.jpg' %}" alt="CMU Logo"> 
        <a class="navbar-brand fw-bold ms-2" href="#">CMU LMS</a> 
      </div> <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu" aria-expanded="false" aria-label="Toggle navigation"> 
        <span class="navbar-toggler-icon"></span> 
      </button> 
      <div class="dropdown">
         <a href="#" class="d-flex align-items-center text-white text-decoration-none dropdown-toggle" id="profileDropdown" data-bs-toggle="dropdown" aria-expanded="false"> 
         {% if user.profile.display_avatar %}
  <img src="{{ user.profile.display_avatar }}" 
       alt="User Avatar"
       class="rounded-circle"
       style="width:40px; height:40px; object-fit:cover;">
{% else %}
  <div class="rounded-circle bg-primary text-white d-flex justify-content-center align-items-center"
       style="width:40px; height:40px; font-weight:bold; font-size:18px;">
    {{ user.first_name|default:user.username|first|upper }}
  </div>
{% endif %}
           <span class="fw-semibold">{{ request.user.username }}</span>
           </a> 
           <ul class="dropdown-menu dropdown-menu-end shadow"> 
            <li><a class="dropdown-item" href="{% url 'accounts:settings' %}"><i class="bi bi-person me-2"></i>Profile</a>
            </li> 
            <li><hr class="dropdown-divider"></li> 
            <li><a class="dropdown-item text-danger" href="{% url 'account_logout' %}">
              <i class="bi bi-box-arrow-right me-2"></i>Logout</a></li> 
            </ul> 
          </div> 
        </div> 
      </nav> 
      <div class="container-fluid"> <div class="row">
         <!-- Sidebar --> 
          <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse"> 
            <div class="position-sticky pt-3"> 
              <ul class="nav flex-column"> 
                <li class="nav-item"><a class="nav-link" href="#">
                  <i class="bi bi-house-door stat-icon"></i>Dashboard</a></li>
                   <li class="nav-item"><a class="nav-link" href="{% url 'admins:teacher_list' %}">
                    <i class="bi bi-person-badge stat-icon"></i>Teachers</a></li>
                     <li class="nav-item"><a class="nav-link" href="{% url 'admins:student_list' %}">
                      <i class="bi bi-people stat-icon"></i>Students</a>
                    </li> 
                    <li class="nav-item"><a class="nav-link" href="{% url 'admins:parent_list' %}">
                      <i class="bi bi-people-fill stat-icon"></i>Parents</a></li> 
            <li class="nav-item"><a class="nav-link" href="{% url 'admins:reports' %}"><i class="bi bi-bar-chart-line stat-icon"></i>Reports</a></li> 
          </ul> 
        </div> 
      </nav>
       <!-- Main content --> 
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-5"> 
          <div class="d-flex justify-content-between align-items-center mt-4 mb-4">
             <h2 class="fw-bold mb-0"><i class="bi bi-speedometer2 me-2">
             </i>School Admin Dashboard</h2> 
            </div>
             <!-- Stats Row --> 
              <div class="row g-4 mb-4"> 
                <div class="col-sm-6 col-lg-3"> 
                  <div class="card shadow-sm p-4 rounded-4 text-center"> 
                    <div class="mb-1"><i class="bi bi-journal-bookmark stat-icon"></i>
                    </div> <h6 class="text-muted">Classes</h6>
                     <h3 class="fw-bold">{{ classes }}</h3> 
                    </div> 
                  </div> 
                  <div class="col-sm-6 col-lg-3"> 
                    <div class="card shadow-sm p-4 rounded-4 text-center"> 
                      <div class="mb-1"><i class="bi bi-person-badge stat-icon"></i>
                      </div> 
                      <h6 class="text-muted">Teachers</h6> <h3 class="fw-bold">{{ teachers }}</h3> 
                    </div> 
                  </div> 
                  <div class="col-sm-6 col-lg-3"> 
                    <div class="card shadow-sm p-4 rounded-4 text-center"> 
                      <div class="mb-1"><i class="bi bi-people stat-icon"></i></div> 
  <h6 class="text-muted">Students</h6> <h3 class="fw-bold">{{ students }}</h3> </div> 
</div> 
<div class="col-sm-6 col-lg-3"> 
  <div class="card shadow-sm p-4 rounded-4 text-center">
     <div class="mb-1"><i class="bi bi-people-fill stat-icon"></i>
    </div> 
    <h6 class="text-muted">Parents</h6> <h3 class="fw-bold">{{ parents }}</h3>
   </div> 
  </div> 
</div>

        <!-- Charts -->
        <div class="row g-4">
          <div class="col-md-6">
            <div class="card p-4 shadow-sm rounded-4 chart-card position-relative">
              <h6 class="fw-bold mb-3"><i class="bi bi-pie-chart me-2"></i>User Role Distribution</h6>
              <canvas id="userStatsChart"></canvas>
              <div class="chart-bg-blob"></div>
            </div>
          </div>

        </div>
      </main>
    </div>
  </div>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>


 <script>
async function loadUserStats() {
  try {
    const response = await fetch("{% url 'admins:user_role_stats' %}");
    const data = await response.json();

    const ctx = document.getElementById('userStatsChart').getContext('2d');

    if (window.userStatsChart instanceof Chart) {
      window.userStatsChart.destroy();
    }

    const total = data.teachers + data.students + data.parents;

    window.userStatsChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Teachers', 'Students', 'Parents'],
        datasets: [{
          data: [data.teachers, data.students, data.parents],
          backgroundColor: ['#3F51B5', '#4CAF50', '#FFC107'],
          borderColor: '#fff',
          borderWidth: 2,
        }]
      },
      options: {
        responsive: true,
        cutout: '65%',
        plugins: {
          legend: { position: 'bottom' },
          title: {
            display: true,
            text: `User Distribution (Total: ${total})`,
            font: { size: 15, weight: 'bold' }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.parsed;
                const pct = ((value / total) * 100).toFixed(1);
                return `${label}: ${value} (${pct}%)`;
              }
            }
          },
          datalabels: {
            color: '#333',
            font: { weight: 'bold', size: 10 },
            formatter: (value, ctx) => {
              const label = ctx.chart.data.labels[ctx.dataIndex];
              const pct = ((value / total) * 100).toFixed(1);
              return `${label}\n${pct}%`;
            },
            anchor: 'end',        // label outside
            align: 'end',         // text alignment outside the arc
            offset: 10,           // distance from chart
            clamp: true,          // prevent overlapping
          }
        }
      },
      plugins: [ChartDataLabels]
    });

  } catch (err) {
    console.error("Chart load error:", err);
  }
}

loadUserStats();
setInterval(loadUserStats, 10000);
</script>


</body>
</html>
